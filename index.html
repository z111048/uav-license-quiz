<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>äº’å‹•å¼ç·šä¸Šç·´ç¿’ç³»çµ±</title>
  <!-- å¼•å…¥ Tailwind CSS é€²è¡Œå¿«é€Ÿæ¨£å¼è¨­è¨ˆ -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* è‡ªå®šç¾©æ¨£å¼ï¼šè™•ç†é¸é …é»æ“Šæ•ˆæœ */
    .option-btn {
      transition: all 0.2s;
    }

    .option-btn:active {
      transform: scale(0.98);
    }

    /* ç¦æ­¢é¸å–æ–‡å­—ï¼Œé¿å…ä½œå¼Šæˆ–èª¤è§¸ */
    .no-select {
      user-select: none;
      -webkit-user-select: none;
    }
  </style>
</head>

<body class="bg-gray-100 text-gray-800 min-h-screen font-sans">

  <!-- ä¸»å®¹å™¨ -->
  <div class="max-w-3xl mx-auto p-4 md:p-6">

    <!-- Header -->
    <header class="text-center mb-6">
      <h1 class="text-3xl font-bold text-blue-600 mb-2">ç·šä¸Šé¡Œåº«ç·´ç¿’ç³»çµ±</h1>
      <p class="text-gray-500 text-sm">æ”¯æ´å€’æ•¸è¨ˆæ™‚ã€ç« ç¯€ç¯©é¸èˆ‡éŒ¯é¡Œå›é¡§</p>
    </header>

    <!-- 1. è¨­å®šé é¢ (Setup View) -->
    <div id="setup-view" class="bg-white rounded-xl shadow-lg p-6 md:p-8">
      <h2 class="text-xl font-semibold mb-4 border-b pb-2">ç·´ç¿’è¨­å®š</h2>

      <!-- ç« ç¯€é¸æ“‡ -->
      <div class="mb-6">
        <label class="block text-gray-700 font-bold mb-2">é¸æ“‡ç« ç¯€ (å¯å¤šé¸)</label>
        <div id="chapter-list" class="grid grid-cols-2 md:grid-cols-3 gap-3">
          <!-- JS å‹•æ…‹ç”Ÿæˆç« ç¯€é¸é … -->
        </div>
      </div>

      <!-- é¡Œæ•¸è¨­å®š -->
      <div class="mb-6">
        <label class="block text-gray-700 font-bold mb-2">ç·´ç¿’é¡Œæ•¸</label>
        <select id="question-count"
          class="w-full p-2 border rounded bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-400">
          <option value="5">5 é¡Œ</option>
          <option value="10">10 é¡Œ</option>
          <option value="20">20 é¡Œ</option>
          <option value="50" selected>50 é¡Œ</option>
          <option value="all">å…¨éƒ¨é¡Œç›®</option>
        </select>
      </div>

      <!-- è¨­å®šé¸é … -->
      <div class="mb-8 flex items-center">
        <input type="checkbox" id="instant-feedback" class="w-5 h-5 text-blue-600" checked>
        <label for="instant-feedback" class="ml-2 text-gray-700">ä½œç­”å¾Œç«‹å³é¡¯ç¤ºæ­£è§£ (è‹¥å–æ¶ˆå‰‡ç›´æ¥è·³ä¸‹ä¸€é¡Œ)</label>
      </div>

      <div class="flex gap-4">
        <button onclick="startQuiz()"
          class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow transition duration-200">
          é–‹å§‹ç·´ç¿’
        </button>
        <button onclick="startReadingMode()"
          class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg shadow transition duration-200">
          é–±è®€æ¨¡å¼
        </button>
      </div>

      <!-- ç™½åå–®æŒ‰éˆ• -->
      <div class="mt-4 text-center">
        <button onclick="openWhitelist()" class="text-indigo-600 hover:text-indigo-800 underline text-sm">
          æŸ¥çœ‹ã€Œç„¡è…¦èƒŒç­”æ¡ˆã€ç™½åå–®æ¸…å–®
        </button>
      </div>
    </div>

    <!-- 2. ä½œç­”é é¢ (Quiz View) -->
    <div id="quiz-view" class="hidden bg-white rounded-xl shadow-lg p-6 md:p-8 relative">
      <!-- é ‚éƒ¨è³‡è¨Šæ¬„ -->
      <div class="flex justify-between items-center mb-6 text-sm md:text-base border-b pb-4">
        <div class="font-bold text-gray-600">
          é¡Œè™Ÿï¼š<span id="current-index" class="text-blue-600 text-xl">1</span> / <span id="total-count">10</span>
        </div>
        <div class="flex items-center gap-4">
          <div class="text-gray-500 bg-gray-100 px-3 py-1 rounded-full text-xs whitespace-nowrap shrink-0"
            id="chapter-tag">ç« ç¯€åç¨±</div>
          <!-- å€’æ•¸è¨ˆæ™‚å™¨ -->
          <div class="flex items-center text-red-500 font-mono font-bold text-xl">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-1" fill="none" viewBox="0 0 24 24"
              stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span id="timer-display">30</span>s
          </div>
        </div>
      </div>

      <!-- é¡Œç›®å€åŸŸ -->
      <div class="mb-6">
        <h3 id="question-text" class="text-xl md:text-2xl font-bold text-gray-800 leading-relaxed">
          é¡Œç›®è¼‰å…¥ä¸­...
        </h3>
      </div>

      <!-- ç­”æ¡ˆæ§åˆ¶ (æ‰‹å‹•é¡¯ç¤ºç­”æ¡ˆ) -->
      <div class="mb-4 flex justify-end">
        <button onclick="toggleAnswerVisibility()" class="text-xs text-blue-500 hover:text-blue-700 underline">
          é¡¯ç¤º/éš±è—ç­”æ¡ˆæç¤º
        </button>
      </div>
      <div id="hint-box" class="hidden mb-4 p-3 bg-yellow-50 text-yellow-800 rounded border border-yellow-200 text-sm">
        æç¤ºï¼šæ­£ç¢ºç­”æ¡ˆæ˜¯ <span id="hint-answer" class="font-bold"></span>
      </div>

      <!-- é¸é …å€åŸŸ -->
      <div id="options-container" class="space-y-3 no-select">
        <!-- JS å‹•æ…‹ç”Ÿæˆé¸é …æŒ‰éˆ• -->
      </div>

      <!-- ä¸‹ä¸€é¡ŒæŒ‰éˆ• (ä½œç­”å¾Œæˆ–é€¾æ™‚å‡ºç¾) -->
      <div id="next-btn-container" class="hidden mt-6">
        <button onclick="nextQuestion()"
          class="w-full bg-gray-800 hover:bg-gray-900 text-white font-bold py-3 rounded-lg transition">
          ä¸‹ä¸€é¡Œ
        </button>
      </div>
    </div>

    <!-- 4. é–±è®€æ¨¡å¼é é¢ (Reading View) -->
    <div id="reading-view" class="hidden bg-white rounded-xl shadow-lg p-6 md:p-8">
      <div class="flex justify-between items-center mb-6 border-b pb-4">
        <h2 class="text-2xl font-bold text-gray-800">é¡Œåº«é–±è®€æ¨¡å¼</h2>
        <button onclick="exitReadingMode()" class="text-gray-500 hover:text-gray-700 font-medium">
          âœ• é—œé–‰
        </button>
      </div>

      <div id="reading-content" class="space-y-8">
        <!-- JS å‹•æ…‹ç”Ÿæˆç« ç¯€èˆ‡é¡Œç›® -->
      </div>

      <div class="mt-8 text-center">
        <button onclick="exitReadingMode()"
          class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-8 rounded-lg shadow transition duration-200">
          è¿”å›è¨­å®šé 
        </button>
      </div>
    </div>

    <!-- 5. ç™½åå–®é é¢ (Whitelist View) -->
    <div id="whitelist-view" class="hidden bg-white rounded-xl shadow-lg p-6 md:p-8">
      <div class="flex justify-between items-center mb-6 border-b pb-4">
        <div>
          <h2 class="text-2xl font-bold text-gray-800">ç­”æ¡ˆç™½åå–®</h2>
          <p class="text-sm text-gray-500 mt-1">çœ‹åˆ°é€™äº›é¸é …å…§å®¹ï¼Œç›´æ¥é¸å®ƒå°±å°äº† (å”¯ä¸€è§£)</p>
        </div>
        <button onclick="closeWhitelist()" class="text-gray-500 hover:text-gray-700 font-medium">
          âœ• é—œé–‰
        </button>
      </div>

      <div class="mb-4">
        <input type="text" id="whitelist-search" oninput="filterWhitelist()" placeholder="æœå°‹ç™½åå–®é—œéµå­—..."
          class="w-full p-2 border rounded bg-gray-50">
      </div>

      <div id="whitelist-content" class="h-96 overflow-y-auto space-y-2 pr-2 border rounded p-2 bg-gray-50">
        <!-- JS å‹•æ…‹ç”Ÿæˆ -->
      </div>
    </div>

    <!-- 3. çµæœçµ±è¨ˆé é¢ (Result View) -->
    <div id="result-view" class="hidden bg-white rounded-xl shadow-lg p-6 md:p-8">
      <h2 class="text-2xl font-bold text-center mb-6">ç·´ç¿’çµæœå ±å‘Š</h2>

      <!-- çµ±è¨ˆå¡ç‰‡ -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8 text-center">
        <div class="p-4 bg-blue-50 rounded-lg">
          <div class="text-sm text-gray-500">ç¸½é¡Œæ•¸</div>
          <div id="res-total" class="text-2xl font-bold text-blue-600">-</div>
        </div>
        <div class="p-4 bg-green-50 rounded-lg">
          <div class="text-sm text-gray-500">ç­”å°</div>
          <div id="res-correct" class="text-2xl font-bold text-green-600">-</div>
        </div>
        <div class="p-4 bg-red-50 rounded-lg">
          <div class="text-sm text-gray-500">éŒ¯èª¤/æœªç­”</div>
          <div id="res-wrong" class="text-2xl font-bold text-red-600">-</div>
        </div>
        <div class="p-4 bg-purple-50 rounded-lg">
          <div class="text-sm text-gray-500">æ­£ç¢ºç‡</div>
          <div id="res-accuracy" class="text-2xl font-bold text-purple-600">-</div>
        </div>
      </div>

      <div class="text-center mb-8 text-gray-600">
        ç¸½è€—æ™‚ï¼š<span id="res-time-spent" class="font-mono font-bold">00:00</span>
      </div>

      <!-- éŒ¯é¡Œæª¢è¦– -->
      <div class="mb-8">
        <h3 class="text-lg font-bold mb-4 border-l-4 border-red-500 pl-3">éŒ¯é¡Œå›é¡§</h3>
        <div id="wrong-questions-list" class="space-y-4">
          <!-- JS å‹•æ…‹ç”ŸæˆéŒ¯é¡Œå¡ç‰‡ -->
        </div>
        <div id="no-wrong-msg" class="hidden text-center text-green-600 py-4 bg-green-50 rounded">
          å¤ªæ£’äº†ï¼é€™æ¬¡ç·´ç¿’æ²’æœ‰éŒ¯é¡Œ ğŸ‰
        </div>
      </div>

      <button onclick="location.reload()"
        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow">
        é‡æ–°é–‹å§‹ç·´ç¿’
      </button>
    </div>

  </div>

  <!-- æ ¸å¿ƒ JavaScript é‚è¼¯ -->
  <script>
    // ==========================================
    // 1. è³‡æ–™çµæ§‹ (User å¯è‡ªè¡Œæ“´å……)
    // ==========================================
    let questions = [];
    let whitelist = []; // æ–°å¢ï¼šç­”æ¡ˆç™½åå–®

    // ==========================================
    // 2. ç‹€æ…‹è®Šæ•¸ç®¡ç†
    // ==========================================
    let currentQuizQueue = []; // æŠ½å‡ºçš„é¡Œç›®ä½‡åˆ—
    let currentIndex = 0;      // ç›®å‰é¡Œè™Ÿ (Index)
    let userRecords = [];      // ä½¿ç”¨è€…ä½œç­”ç´€éŒ„
    let timer = null;          // è¨ˆæ™‚å™¨ ID
    let timeLeft = 10;         // å‰©é¤˜ç§’æ•¸
    let quizStartTime = 0;     // ç·´ç¿’é–‹å§‹æ™‚é–“æˆ³è¨˜
    let settings = {
      chapters: [],
      count: 10,
      instantFeedback: true
    };
    const TIME_LIMIT_PER_QUESTION = 10;

    // ==========================================
    // 3. åˆå§‹åŒ– (Setup Phase)
    // ==========================================

    // é é¢è¼‰å…¥å¾ŒåŸ·è¡Œ
    window.onload = function () {
      fetch("process_question_bank.json")
        .then(response => response.json())
        .then(data => {
          // æ”¯æ´æ–°èˆŠæ ¼å¼ç›¸å®¹
          if (Array.isArray(data)) {
            questions = data;
          } else {
            questions = data.questions;
            whitelist = data.answer_option_whitelist || [];
          }
          initChapters();
        })
        .catch(error => console.error("Error loading questions:", error));
    };

    // æå–ä¸¦æ¸²æŸ“æ‰€æœ‰ç« ç¯€
    function initChapters() {
      const chapterSet = new Set(questions.map(q => q.chapter));
      const container = document.getElementById('chapter-list');

      chapterSet.forEach(chapter => {
        const wrapper = document.createElement('div');
        wrapper.className = "flex items-center space-x-2";

        const checkbox = document.createElement('input');
        checkbox.type = "checkbox";
        checkbox.value = chapter;
        checkbox.id = `ch-${chapter}`;
        checkbox.className = "w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500";

        const label = document.createElement('label');
        label.htmlFor = `ch-${chapter}`;
        label.innerText = chapter;
        label.className = "text-sm text-gray-700 cursor-pointer";

        wrapper.appendChild(checkbox);
        wrapper.appendChild(label);
        container.appendChild(wrapper);
      });
    }

    // é–‹å§‹ç·´ç¿’æŒ‰éˆ•é‚è¼¯
    function startQuiz() {
      // 1. å–å¾—ä½¿ç”¨è€…è¨­å®š
      const checkboxes = document.querySelectorAll('#chapter-list input[type="checkbox"]:checked');
      const selectedChapters = Array.from(checkboxes).map(cb => cb.value);
      const countSelect = document.getElementById('question-count').value;
      settings.instantFeedback = document.getElementById('instant-feedback').checked;

      // 2. ç¯©é¸é¡Œç›®
      let filteredQuestions = questions;
      if (selectedChapters.length > 0) {
        filteredQuestions = questions.filter(q => selectedChapters.includes(q.chapter));
      }

      if (filteredQuestions.length === 0) {
        alert("æ‰€é¸ç« ç¯€æ²’æœ‰é¡Œç›®ï¼Œè«‹é‡æ–°é¸æ“‡ï¼");
        return;
      }

      // 3. éš¨æ©Ÿæ´—ç‰Œ (Fisher-Yates Shuffle)
      shuffleArray(filteredQuestions);

      // 4. æˆªå–é¡Œç›®æ•¸é‡
      if (countSelect !== 'all') {
        currentQuizQueue = filteredQuestions.slice(0, parseInt(countSelect));
      } else {
        currentQuizQueue = filteredQuestions;
      }

      // 5. åˆå§‹åŒ–ç‹€æ…‹
      currentIndex = 0;
      userRecords = [];
      quizStartTime = Date.now();

      // 6. åˆ‡æ›ä»‹é¢
      document.getElementById('setup-view').classList.add('hidden');
      document.getElementById('quiz-view').classList.remove('hidden');
      document.getElementById('total-count').innerText = currentQuizQueue.length;

      // 7. æ¸²æŸ“ç¬¬ä¸€é¡Œ
      renderQuestion();
    }

    // æ´—ç‰Œæ¼”ç®—æ³•
    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    // ==========================================
    // 4. ä½œç­”é‚è¼¯ (Quiz Phase)
    // ==========================================

    function renderQuestion() {
      const currentQ = currentQuizQueue[currentIndex];

      // æ›´æ–° UI è³‡è¨Š
      document.getElementById('current-index').innerText = currentIndex + 1;
      document.getElementById('chapter-tag').innerText = currentQ.chapter;
      document.getElementById('question-text').innerText = currentQ.question;
      document.getElementById('hint-answer').innerText = currentQ.options[currentQ.answer]; // é å¡«ç­”æ¡ˆæç¤º
      document.getElementById('hint-box').classList.add('hidden'); // éš±è—æç¤º

      // éš±è— "ä¸‹ä¸€é¡Œ" æŒ‰éˆ•
      document.getElementById('next-btn-container').classList.add('hidden');

      // æ¸²æŸ“é¸é …
      const optionsContainer = document.getElementById('options-container');
      optionsContainer.innerHTML = ''; // æ¸…ç©ºèˆŠé¸é …

      for (const [key, value] of Object.entries(currentQ.options)) {
        const btn = document.createElement('div');
        // é è¨­æ¨£å¼
        btn.className = `option-btn w-full p-4 mb-3 rounded-lg border-2 border-gray-200 cursor-pointer hover:border-blue-400 hover:bg-blue-50 flex items-center transition bg-white`;
        btn.dataset.key = key; // å„²å­˜é¸é … Key (A, B, C, D)
        btn.onclick = () => handleAnswer(key);

        btn.innerHTML = `
                    <span class="font-bold w-8 h-8 flex items-center justify-center bg-gray-200 rounded-full mr-4 text-gray-700 group-hover:bg-blue-200">${key}</span>
                    <span class="text-lg text-gray-800">${value}</span>
                `;
        optionsContainer.appendChild(btn);
      }

      // é‡ç½®ä¸¦å•Ÿå‹•è¨ˆæ™‚å™¨
      resetTimer();
    }

    function resetTimer() {
      clearInterval(timer);
      timeLeft = TIME_LIMIT_PER_QUESTION;
      updateTimerUI();

      timer = setInterval(() => {
        timeLeft--;
        updateTimerUI();

        if (timeLeft <= 0) {
          handleTimeout();
        }
      }, 1000);
    }

    function updateTimerUI() {
      const display = document.getElementById('timer-display');
      display.innerText = timeLeft;
      if (timeLeft <= 5) {
        display.parentElement.classList.add('animate-pulse'); // æœ€å¾Œ5ç§’é–ƒçˆ
      } else {
        display.parentElement.classList.remove('animate-pulse');
      }
    }

    // è™•ç†ä½¿ç”¨è€…ä½œç­”
    function handleAnswer(selectedKey) {
      clearInterval(timer); // åœæ­¢è¨ˆæ™‚
      const currentQ = currentQuizQueue[currentIndex];
      const isCorrect = selectedKey === currentQ.answer;
      const timeSpent = TIME_LIMIT_PER_QUESTION - timeLeft;

      // ç´€éŒ„ä½œç­”
      userRecords.push({
        questionId: currentQ.id,
        question: currentQ.question,
        chapter: currentQ.chapter,
        correctAnswer: currentQ.answer,
        userAnswer: selectedKey,
        isCorrect: isCorrect,
        timeSpent: timeSpent
      });

      // é–å®šæ‰€æœ‰é¸é …ä¸å¯å†é»
      disableOptions();

      // å¦‚æœè¨­å®šç‚º "ç«‹å³é¡¯ç¤ºç­”æ¡ˆ"
      if (settings.instantFeedback) {
        highlightOptions(currentQ.answer, selectedKey);
        // é¡¯ç¤ºä¸‹ä¸€é¡ŒæŒ‰éˆ• (è®“ä½¿ç”¨è€…è‡ªè¡Œæ±ºå®šä½•æ™‚ç¹¼çºŒ)
        document.getElementById('next-btn-container').classList.remove('hidden');
      } else {
        // å¦‚æœä¸é¡¯ç¤ºåé¥‹ï¼Œç¨å¾®å»¶é²å¾Œè‡ªå‹•è·³è½‰ (æˆ–ä¹Ÿé¡¯ç¤ºæŒ‰éˆ•ï¼Œé€™è£¡é¸æ“‡è‡ªå‹•è·³è½‰ä»¥åŠ å¿«ç¯€å¥)
        setTimeout(nextQuestion, 500);
      }
    }

    // è™•ç†é€¾æ™‚
    function handleTimeout() {
      clearInterval(timer);
      const currentQ = currentQuizQueue[currentIndex];

      // ç´€éŒ„ç‚ºæœªä½œç­” (è¦–ç‚ºéŒ¯èª¤)
      userRecords.push({
        questionId: currentQ.id,
        question: currentQ.question,
        chapter: currentQ.chapter,
        correctAnswer: currentQ.answer,
        userAnswer: null, // æœªä½œç­”
        isCorrect: false,
        timeSpent: TIME_LIMIT_PER_QUESTION
      });

      disableOptions();

      // é€¾æ™‚å¼·åˆ¶é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ
      highlightOptions(currentQ.answer, null);

      // é¡¯ç¤ºæ–‡å­—æç¤º
      const optionsContainer = document.getElementById('options-container');
      const msg = document.createElement('div');
      msg.className = "text-center text-red-500 font-bold mt-2";
      msg.innerText = "æ™‚é–“åˆ°ï¼";
      optionsContainer.prepend(msg);

      // é¡¯ç¤ºä¸‹ä¸€é¡ŒæŒ‰éˆ•
      document.getElementById('next-btn-container').classList.remove('hidden');
    }

    // è¦–è¦ºåŒ–é¸é … (ç¶ è‰²/ç´…è‰²)
    function highlightOptions(correctKey, userKey) {
      const buttons = document.querySelectorAll('.option-btn');
      buttons.forEach(btn => {
        const key = btn.dataset.key;

        // ç§»é™¤ hover æ•ˆæœ
        btn.classList.remove('hover:border-blue-400', 'hover:bg-blue-50', 'cursor-pointer');

        if (key === correctKey) {
          // æ­£è§£ï¼šç¶ è‰²
          btn.classList.add('bg-green-100', 'border-green-500', 'text-green-800');
          btn.querySelector('span').classList.add('bg-green-200');
        } else if (key === userKey && userKey !== correctKey) {
          // é¸éŒ¯ï¼šç´…è‰²
          btn.classList.add('bg-red-100', 'border-red-500', 'text-red-800');
          btn.querySelector('span').classList.add('bg-red-200');
        } else {
          // å…¶ä»–ï¼šè®Šæ·¡
          btn.classList.add('opacity-50');
        }
      });
    }

    function disableOptions() {
      const buttons = document.querySelectorAll('.option-btn');
      buttons.forEach(btn => btn.onclick = null);
    }

    // æ‰‹å‹•é¡¯ç¤º/éš±è—ç­”æ¡ˆæç¤º (ä¸æœƒåœæ­¢è¨ˆæ™‚ï¼Œåƒ…ä¾›å·çœ‹)
    function toggleAnswerVisibility() {
      const hintBox = document.getElementById('hint-box');
      hintBox.classList.toggle('hidden');
    }

    function nextQuestion() {
      if (currentIndex < currentQuizQueue.length - 1) {
        currentIndex++;
        renderQuestion();
      } else {
        finishQuiz();
      }
    }

    // ==========================================
    // 5. çµç®—é‚è¼¯ (Result Phase)
    // ==========================================

    function finishQuiz() {
      // åˆ‡æ›è¦–åœ–
      document.getElementById('quiz-view').classList.add('hidden');
      document.getElementById('result-view').classList.remove('hidden');

      // è¨ˆç®—æ•¸æ“š
      const total = userRecords.length;
      const correctCount = userRecords.filter(r => r.isCorrect).length;
      const wrongCount = total - correctCount;
      const accuracy = Math.round((correctCount / total) * 100);

      // è¨ˆç®—ç¸½è€—æ™‚
      const totalSeconds = userRecords.reduce((sum, r) => sum + r.timeSpent, 0);
      const minutes = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
      const seconds = (totalSeconds % 60).toString().padStart(2, '0');

      // æ›´æ–°æ‘˜è¦ UI
      document.getElementById('res-total').innerText = total;
      document.getElementById('res-correct').innerText = correctCount;
      document.getElementById('res-wrong').innerText = wrongCount;
      document.getElementById('res-accuracy').innerText = `${accuracy}%`;
      document.getElementById('res-time-spent').innerText = `${minutes}:${seconds}`;

      // ç”ŸæˆéŒ¯é¡Œæ¸…å–®
      renderWrongQuestions();
    }

    function renderWrongQuestions() {
      const container = document.getElementById('wrong-questions-list');
      const noWrongMsg = document.getElementById('no-wrong-msg');
      container.innerHTML = '';

      const wrongRecords = userRecords.filter(r => !r.isCorrect);

      if (wrongRecords.length === 0) {
        noWrongMsg.classList.remove('hidden');
        return;
      }
      noWrongMsg.classList.add('hidden');

      wrongRecords.forEach((record, index) => {
        const card = document.createElement('div');
        card.className = "bg-white border border-gray-200 rounded-lg p-4 shadow-sm";

        const userAnswerText = record.userAnswer
          ? `${record.userAnswer}. ${currentQuizQueue.find(q => q.id === record.questionId).options[record.userAnswer]}`
          : "æœªä½œç­” (é€¾æ™‚)";

        const correctAnswerText = `${record.correctAnswer}. ${currentQuizQueue.find(q => q.id === record.questionId).options[record.correctAnswer]}`;

        card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <span class="inline-block bg-red-100 text-red-600 text-xs px-2 py-1 rounded font-bold">éŒ¯é¡Œ</span>
                        <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">${record.chapter}</span>
                    </div>
                    <p class="font-bold text-gray-800 mb-3">${record.question}</p>
                    <div class="text-sm space-y-1">
                        <div class="flex">
                            <span class="w-20 text-gray-500">æ‚¨çš„ç­”æ¡ˆï¼š</span>
                            <span class="text-red-600 font-medium">${userAnswerText}</span>
                        </div>
                        <div class="flex">
                            <span class="w-20 text-gray-500">æ­£ç¢ºç­”æ¡ˆï¼š</span>
                            <span class="text-green-600 font-medium">${correctAnswerText}</span>
                        </div>
                    </div>
                `;
        container.appendChild(card);
      });
    }

    // ==========================================
    // 6. é–±è®€æ¨¡å¼é‚è¼¯ (Reading Mode)
    // ==========================================

    function startReadingMode() {
      // 1. å–å¾—ä½¿ç”¨è€…è¨­å®š (ç« ç¯€)
      const checkboxes = document.querySelectorAll('#chapter-list input[type="checkbox"]:checked');
      let selectedChapters = Array.from(checkboxes).map(cb => cb.value);

      // å¦‚æœæ²’é¸ï¼Œé è¨­é¡¯ç¤ºå…¨éƒ¨
      if (selectedChapters.length === 0) {
        const allCheckboxes = document.querySelectorAll('#chapter-list input[type="checkbox"]');
        selectedChapters = Array.from(allCheckboxes).map(cb => cb.value);
      }

      // 2. ç¯©é¸é¡Œç›®
      const filteredQuestions = questions.filter(q => selectedChapters.includes(q.chapter));

      if (filteredQuestions.length === 0) {
        alert("æ²’æœ‰é¡Œç›®å¯é¡¯ç¤ºï¼");
        return;
      }

      // 3. ä¾ç« ç¯€åˆ†çµ„
      const grouped = {};
      selectedChapters.forEach(ch => {
        grouped[ch] = filteredQuestions.filter(q => q.chapter === ch);
      });

      // 4. æ¸²æŸ“å…§å®¹
      const container = document.getElementById('reading-content');
      container.innerHTML = '';

      for (const chapter of selectedChapters) {
        const chapterQuestions = grouped[chapter];
        if (!chapterQuestions || chapterQuestions.length === 0) continue;

        const chapterBlock = document.createElement('div');
        chapterBlock.className = "mb-8";

        // ç« ç¯€æ¨™é¡Œ
        const title = document.createElement('h3');
        title.className = "text-xl font-bold text-blue-800 bg-blue-50 p-3 rounded-lg mb-4 border-l-4 border-blue-600";
        title.innerText = `${chapter} (å…± ${chapterQuestions.length} é¡Œ)`;
        chapterBlock.appendChild(title);

        // é¡Œç›®åˆ—è¡¨
        const list = document.createElement('div');
        list.className = "space-y-6";

        chapterQuestions.forEach((q, idx) => {
          const qItem = document.createElement('div');
          qItem.className = "border-b border-gray-200 pb-4 last:border-0";

          // é¸é … HTML
          let optionsHtml = '<div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-2">';
          for (const [key, val] of Object.entries(q.options)) {
            const isAnswer = key === q.answer;
            const style = isAnswer ? "text-green-700 font-bold bg-green-50 border-green-200" : "text-gray-600";
            const checkMark = isAnswer ? "âœ“ " : "";
            optionsHtml += `
              <div class="p-2 rounded border border-transparent ${style}">
                ${checkMark}<span class="font-semibold">${key}.</span> ${val}
              </div>
            `;
          }
          optionsHtml += '</div>';

          // åˆ¤æ–·æ˜¯å¦å¯ç„¡è…¦èƒŒ
          const memorizeBadge = q.can_memorize_directly
            ? `<span class="inline-block bg-indigo-100 text-indigo-700 text-xs px-2 py-1 rounded-full font-bold ml-2 whitespace-nowrap shrink-0">âš¡ å¯ç„¡è…¦èƒŒ</span>`
            : '';

          qItem.innerHTML = `
            <div class="flex gap-2">
              <span class="font-bold text-gray-500 text-sm min-w-[2rem] pt-1">#${q.id}</span>
              <div class="flex-1">
                <div class="flex items-start justify-between">
                    <p class="font-bold text-gray-800 text-lg mb-2">${q.question}</p>
                    ${memorizeBadge}
                </div>
                ${optionsHtml}
                <div class="mt-2 text-sm text-gray-500">
                  æ­£ç¢ºç­”æ¡ˆï¼š<span class="font-bold text-green-600 text-lg">${q.answer}</span>
                </div>
              </div>
            </div>
          `;
          list.appendChild(qItem);
        });

        chapterBlock.appendChild(list);
        container.appendChild(chapterBlock);
      }

      // 5. åˆ‡æ›è¦–åœ–
      document.getElementById('setup-view').classList.add('hidden');
      document.getElementById('reading-view').classList.remove('hidden');
      window.scrollTo(0, 0);
    }

    function exitReadingMode() {
      document.getElementById('reading-view').classList.add('hidden');
      document.getElementById('setup-view').classList.remove('hidden');
      window.scrollTo(0, 0);
    }

    // ==========================================
    // 7. ç™½åå–®è¦–åœ–ç›¸é—œ (Whitelist)
    // ==========================================

    function openWhitelist() {
      document.getElementById('setup-view').classList.add('hidden');
      document.getElementById('whitelist-view').classList.remove('hidden');

      renderWhitelist(whitelist);
    }

    function closeWhitelist() {
      document.getElementById('whitelist-view').classList.add('hidden');
      document.getElementById('setup-view').classList.remove('hidden');
    }

    function renderWhitelist(list) {
      const container = document.getElementById('whitelist-content');
      container.innerHTML = '';

      if (!list || list.length === 0) {
        container.innerHTML = '<div class="text-gray-500 text-center py-4">ç›®å‰æ²’æœ‰è³‡æ–™</div>';
        return;
      }

      list.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = "p-2 bg-white border rounded text-gray-700 text-sm hover:bg-indigo-50 transition";
        div.innerText = item;
        container.appendChild(div);
      });
    }

    function filterWhitelist() {
      const keyword = document.getElementById('whitelist-search').value.toLowerCase();
      const filtered = whitelist.filter(item => item.toLowerCase().includes(keyword));
      renderWhitelist(filtered);
    }

  </script>
</body>

</html>